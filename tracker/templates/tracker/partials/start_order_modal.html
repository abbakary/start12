<!-- Unified Start Order Modal -->
<div class="modal fade" id="startOrderModal" tabindex="-1" data-bs-keyboard="false" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-primary border-3">
      <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="modal-title">
          <i class="fa fa-play-circle me-2"></i>Quick Start Order
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="resetStartOrderForm()"></button>
      </div>
      
      <div class="modal-body" id="startOrderBody">
        <p class="text-muted mb-4">
          <i class="fa fa-info-circle me-2"></i>
          Enter the vehicle plate number to start tracking a new order. You can upload documents or enter details later.
        </p>

        <form id="startOrderForm" onsubmit="submitStartOrder(event)">
          <div class="mb-4">
            <label class="form-label fw-bold">Vehicle Plate Number <span class="text-danger">*</span></label>
            <input
              type="text"
              id="plateNumber"
              class="form-control form-control-lg text-uppercase border-2"
              placeholder="e.g., ABC 123 XYZ"
              required
              autofocus
              style="letter-spacing: 0.1em; font-weight: bold; font-size: 1.1rem;">
            <small class="text-muted d-block mt-2">
              <i class="fa fa-car me-1"></i>
              This will be the unique identifier for the order
            </small>
            <div id="plateCheckResult" class="mt-2"></div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold">Order Type</label>
            <div class="d-flex gap-2 flex-wrap">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="orderType" id="typeService" value="service" checked>
                <label class="form-check-label" for="typeService">
                  <i class="fa fa-wrench me-1"></i>Service
                </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="orderType" id="typeSales" value="sales">
                <label class="form-check-label" for="typeSales">
                  <i class="fa fa-shopping-cart me-1"></i>Sales
                </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="orderType" id="typeInquiry" value="inquiry">
                <label class="form-check-label" for="typeInquiry">
                  <i class="fa fa-question-circle me-1"></i>Inquiry
                </label>
              </div>
            </div>
          </div>

          <!-- Service selection (populated dynamically) -->
          <div class="mb-3" id="startOrderServicesWrapper" style="display:none;">
            <label class="form-label fw-bold">Select Services (optional)</label>
            <div id="startOrderServices" class="row g-2"></div>
            <input type="hidden" id="startOrderEstimatedDuration" name="estimated_duration" value="">
          </div>

          <div class="alert alert-light border-start border-4" style="border-color: #667eea !important;">
            <small class="text-muted">
              <strong>Next Steps:</strong><br>
              After starting, you can immediately upload an invoice to auto-extract customer, vehicle, and service details, or continue manually.
            </small>
          </div>
        </form>
      </div>

      <!-- Loading State -->
      <div id="startOrderLoading" style="display: none;" class="modal-body text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted mb-2">Creating order...</p>
        <small class="text-secondary">Please wait while we initialize your order</small>
      </div>
      
      <div class="modal-footer bg-light d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" onclick="resetStartOrderForm()">
          <i class="fa fa-times me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary btn-lg px-5" onclick="submitStartOrder(event)" id="startOrderBtn">
          <i class="fa fa-play me-2"></i><span id="startBtnText">Start Order</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function resetStartOrderForm() {
  document.getElementById('startOrderForm').reset();
  document.getElementById('typeService').checked = true;
  document.getElementById('plateNumber').value = '';
  document.getElementById('startOrderBody').style.display = 'block';
  document.getElementById('startOrderLoading').style.display = 'none';
  document.getElementById('startOrderBtn').disabled = false;
  document.getElementById('startBtnText').textContent = 'Start Order';
  // reset plate check result
  const res = document.getElementById('plateCheckResult'); if(res) res.innerHTML = '';
  // show/hide services wrapper
  document.getElementById('startOrderServicesWrapper').style.display = 'none';
}

function submitStartOrder(event) {
  event.preventDefault();

  const plateNumber = document.getElementById('plateNumber').value.trim().toUpperCase();
  const orderType = document.querySelector('input[name="orderType"]:checked').value;

  if (!plateNumber) {
    alert('Please enter a vehicle plate number');
    document.getElementById('plateNumber').focus();
    return;
  }

  // Validate plate format (basic)
  if (plateNumber.length < 5) {
    alert('Please enter a valid plate number');
    return;
  }

  // Gather selected services
  const svcBoxes = document.querySelectorAll('#startOrderServices input[type="checkbox"]:checked');
  const services = Array.from(svcBoxes).map(cb => cb.value);
  const estimatedDuration = document.getElementById('startOrderEstimatedDuration').value || null;

  // Check plate result choices
  const plateCheckEl = document.getElementById('plateCheckResult');
  let useExisting = false;
  let existingCustomerId = null;
  if (plateCheckEl && plateCheckEl.dataset && plateCheckEl.dataset.existing === 'true') {
    // If user selected to use existing, the button will have set data-use-existing
    useExisting = plateCheckEl.dataset.useExisting === 'true';
    existingCustomerId = plateCheckEl.dataset.existingCustomerId || null;
  }

  // Show loading state
  document.getElementById('startOrderBody').style.display = 'none';
  document.getElementById('startOrderLoading').style.display = 'block';
  document.getElementById('startOrderBtn').disabled = true;
  document.getElementById('startBtnText').textContent = 'Creating...';

  const payload = {
    plate_number: plateNumber,
    order_type: orderType,
    service_selection: services
  };
  if (estimatedDuration) payload.estimated_duration = Number(estimatedDuration);
  if (useExisting && existingCustomerId) {
    payload.use_existing_customer = true;
    payload.existing_customer_id = Number(existingCustomerId);
  }

  // Send API request
  fetch('{% url "tracker:api_start_order" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Close modal and redirect
      const modal = bootstrap.Modal.getInstance(document.getElementById('startOrderModal'));
      modal.hide();

      // Redirect after brief delay to show success
      setTimeout(() => {
        window.location.href = `/orders/started/${data.order_id}/`;
      }, 300);
    } else if (data.existing_customer) {
      // Backend indicates existing customer found; show selection
      showPlateExistingNotice(data.existing_customer, data.existing_vehicle);
      document.getElementById('startOrderBody').style.display = 'block';
      document.getElementById('startOrderLoading').style.display = 'none';
      document.getElementById('startOrderBtn').disabled = false;
      document.getElementById('startBtnText').textContent = 'Start Order';
    } else {
      // Show error
      document.getElementById('startOrderBody').style.display = 'block';
      document.getElementById('startOrderLoading').style.display = 'none';
      document.getElementById('startOrderBtn').disabled = false;
      document.getElementById('startBtnText').textContent = 'Start Order';
      alert('Error: ' + (data.error || 'Failed to start order'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('startOrderBody').style.display = 'block';
    document.getElementById('startOrderLoading').style.display = 'none';
    document.getElementById('startOrderBtn').disabled = false;
    document.getElementById('startBtnText').textContent = 'Start Order';
    alert('Error starting order. Please try again.');
  });
}

// Plate check helper
function checkPlateExists() {
  const plateNumber = document.getElementById('plateNumber').value.trim().toUpperCase();
  if (!plateNumber || plateNumber.length < 5) return;

  fetch('{% url "tracker:api_check_plate" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ plate_number: plateNumber })
  })
  .then(r => r.json())
  .then(data => {
    if (data.found) {
      showPlateExistingNotice(data.customer, data.vehicle);
    } else {
      // show services for manual selection
      document.getElementById('startOrderServicesWrapper').style.display = 'block';
      // clear plate check data
      const res = document.getElementById('plateCheckResult');
      if(res) { res.innerHTML = ''; res.dataset.existing = 'false'; }
    }
  })
  .catch(err => console.error('Plate check error', err));
}

// Show UI notice for existing plate
function showPlateExistingNotice(customer, vehicle) {
  const container = document.getElementById('plateCheckResult');
  if (!container) return;
  container.dataset.existing = 'true';
  container.innerHTML = `
    <div class="alert alert-info d-flex justify-content-between align-items-center">
      <div>
        <strong>Existing Customer Found:</strong> ${customer.full_name} (${customer.phone})<br>
        <small class="text-muted">Vehicle: ${vehicle.plate} ${vehicle.make || ''} ${vehicle.model || ''}</small>
      </div>
      <div>
        <button type="button" class="btn btn-sm btn-primary me-2" onclick="useExistingCustomer(${customer.id})">Use Existing</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="continueAsNew()">Continue as New</button>
      </div>
    </div>
  `;
  // hide services until user chooses
  document.getElementById('startOrderServicesWrapper').style.display = 'none';
}

function useExistingCustomer(customerId) {
  const container = document.getElementById('plateCheckResult');
  container.dataset.useExisting = 'true';
  container.dataset.existingCustomerId = String(customerId);
  // show services
  document.getElementById('startOrderServicesWrapper').style.display = 'block';
}

function continueAsNew() {
  const container = document.getElementById('plateCheckResult');
  container.dataset.useExisting = 'false';
  container.dataset.existingCustomerId = '';
  document.getElementById('startOrderServicesWrapper').style.display = 'block';
}

// Populate services on modal shown
document.addEventListener('shown.bs.modal', function(e) {
  if (e.target.id === 'startOrderModal') {
    resetStartOrderForm();
    // fetch service types
    fetch('{% url "tracker:api_service_types" %}', { method: 'GET', headers: { 'X-CSRFToken': getCookie('csrftoken') } })
      .then(r => r.json())
      .then(data => {
        if (Array.isArray(data.service_types)) {
          const wrapper = document.getElementById('startOrderServices');
          wrapper.innerHTML = '';
          data.service_types.forEach(svc => {
            const id = 'svc_' + svc.name.replace(/[^A-Za-z0-9_]/g,'_');
            const col = document.createElement('div'); col.className = 'col-md-4';
            col.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" id="${id}" value="${svc.name}"><label class="form-check-label" for="${id}">${svc.name}</label></div>`;
            wrapper.appendChild(col);
          });
          document.getElementById('startOrderServicesWrapper').style.display = 'block';
        }
      });
  }
});

// Trigger plate check on blur
const plateInput = document.getElementById('plateNumber');
if (plateInput) {
  plateInput.addEventListener('blur', checkPlateExists);
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Auto-focus and reset when modal opens
document.addEventListener('shown.bs.modal', function(e) {
  if (e.target.id === 'startOrderModal') {
    resetStartOrderForm();
  }
});
</script>
