{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}

{% block title %}Order {{ order.order_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-md-8">
        <h4>
          <i class="fa fa-play me-2"></i>Order {{ order.order_number }}
          {% if vehicle %}
            <small class="text-muted ms-2"><i class="fa fa-car"></i> {{ vehicle.plate_number }}</small>
          {% endif %}
        </h4>
      </div>
      <div class="col-md-4">
        <ol class="breadcrumb justify-content-end">
          <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
          <li class="breadcrumb-item"><a href="{% url 'tracker:started_orders_dashboard' %}">Started Orders</a></li>
          <li class="breadcrumb-item active">{{ order.order_number }}</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-left border-4" style="border-left-color: #667eea;">
        <div class="card-body py-3">
          <div class="row align-items-center">
            <div class="col-md-6">
              <p class="mb-2"><strong>Status:</strong> <span class="badge bg-secondary">New</span></p>
              <p class="mb-0"><strong>Started:</strong> <span class="text-muted">{{ order.started_at|date:"M d, Y H:i" }}</span></p>
            </div>
            <div class="col-md-6 text-md-end">
              <p class="mb-2"><strong>Type:</strong> 
                {% if order.type == 'service' %}
                  <span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>
                {% elif order.type == 'sales' %}
                  <span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>
                {% else %}
                  <span class="badge bg-secondary">{{ order.type }}</span>
                {% endif %}
              </p>
              <p class="mb-0"><strong>Progress:</strong> <span class="text-muted">Step 1 of 3</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons -->
  <div class="row g-3 mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-info btn-lg" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('customer')">
              <i class="fa fa-user me-2"></i>Customer Info
            </button>
            {% if vehicle %}
            <button class="btn btn-info btn-lg" data-bs-toggle="modal" data-bs-target="#editDetailsModal" onclick="setEditMode('vehicle')">
              <i class="fa fa-car me-2"></i>Vehicle Info
            </button>
            {% endif %}

            <!-- Upload Invoice for this order -->
            <button type="button" id="uploadInvoiceBtn" class="btn btn-secondary btn-lg">
              <i class="fa fa-file-upload me-2"></i>Upload Invoice
            </button>

            <!-- Edit Order Details (services) -->
            <button type="button" id="editOrderDetailsBtn" class="btn btn-outline-primary btn-lg" data-bs-toggle="modal" data-bs-target="#editOrderDetailsModal">
              <i class="fa fa-list me-2"></i>Edit Order Details
            </button>

            <form method="post" class="d-inline m-0">
              {% csrf_token %}
              <input type="hidden" name="action" value="complete_order">
              <button type="submit" class="btn btn-success btn-lg" onclick="return confirm('Complete this order?')">
                <i class="fa fa-check me-2"></i>Complete Order
              </button>
            </form>
          </div>

          <!-- Edit Order Details Modal -->
          <div class="modal fade" id="editOrderDetailsModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fa fa-list me-2"></i>Edit Order Details</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="orderDetailsForm" method="post">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="update_order_details">
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Select Services</label>
                      <div id="orderServicesContainer" class="row g-2">Loading services...</div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold">Estimated Duration (minutes)</label>
                      <input type="number" name="estimated_duration" id="orderEstimatedDuration" class="form-control" value="{{ order.estimated_duration|default:'' }}" min="0">
                    </div>
                    <div class="mb-2 text-muted small">Selected services will be appended to the order description for quick reference.</div>
                  </div>
                  <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <script>
            // Open document modal and attach upload to this order
            document.getElementById('uploadInvoiceBtn').addEventListener('click', function(){
              // set order id on global docModal instance
              docModal.orderId = {{ order.id }};
              // prefill vehicle plate if available
              const plateEl = document.getElementById('vehiclePlate');
              if (plateEl) plateEl.value = '{{ vehicle.plate_number|default:"" }}';
              // reset file input and UI
              document.getElementById('documentFile').value = '';
              document.getElementById('fileNameDisplay').classList.add('d-none');
              document.getElementById('extractionResults').classList.add('d-none');
              document.getElementById('extractionError').classList.add('d-none');
              document.getElementById('applyExtractionToOrderBtn').classList.add('d-none');

              const modal = new bootstrap.Modal(document.getElementById('documentCaptureModal'));
              modal.show();
            });

            // Populate services in Edit Order Details modal
            document.getElementById('editOrderDetailsBtn').addEventListener('click', function(){
              const container = document.getElementById('orderServicesContainer');
              container.innerHTML = 'Loading...';
              fetch('{% url "tracker:api_service_types" %}', { method: 'GET', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }})
                .then(r => r.json())
                .then(data => {
                  container.innerHTML = '';
                  const existingDesc = `{{ order.description|default:'' }}`.toLowerCase();
                  if (Array.isArray(data.service_types)) {
                    data.service_types.forEach(svc => {
                      const id = 'svc_edit_' + svc.name.replace(/[^A-Za-z0-9_]/g,'_');
                      const checked = existingDesc.indexOf(svc.name.toLowerCase()) !== -1 ? 'checked' : '';
                      const col = document.createElement('div'); col.className = 'col-md-6';
                      col.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" id="${id}" name="services" value="${svc.name}" ${checked}><label class="form-check-label" for="${id}">${svc.name} <span class="text-muted small">(${svc.estimated_minutes || 0}m)</span></label></div>`;
                      container.appendChild(col);
                    });
                  } else {
                    container.innerHTML = '<div class="text-muted">No services available</div>';
                  }
                })
                .catch(err => { container.innerHTML = '<div class="text-danger">Failed to load services</div>'; console.error(err); });
            });

            // No-op: form will submit and be handled by server-side POST handler
          </script>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fa fa-eye me-2"></i>Overview
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
        <i class="fa fa-file me-2"></i>Documents <span class="badge bg-danger ms-1">{{ documents.count }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
        <i class="fa fa-list me-2"></i>Order Details
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
            </div>
            <div class="card-body">
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Name</small>
                  <strong>{{ customer.full_name }}</strong>
                </div>
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Phone</small>
                  <strong><a href="tel:{{ customer.phone }}">{{ customer.phone }}</a></strong>
                </div>
                {% if customer.email %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Email</small>
                  <strong><a href="mailto:{{ customer.email }}">{{ customer.email }}</a></strong>
                </div>
                {% endif %}
                {% if customer.address %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Address</small>
                  <strong>{{ customer.address }}</strong>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0"><i class="fa fa-car me-2"></i>Vehicle Information</h6>
            </div>
            <div class="card-body">
              {% if vehicle %}
              <div class="list-group list-group-flush">
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Plate Number</small>
                  <strong>{{ vehicle.plate_number }}</strong>
                </div>
                {% if vehicle.make %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Make</small>
                  <strong>{{ vehicle.make }}</strong>
                </div>
                {% endif %}
                {% if vehicle.model %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Model</small>
                  <strong>{{ vehicle.model }}</strong>
                </div>
                {% endif %}
                {% if vehicle.vehicle_type %}
                <div class="list-group-item px-0">
                  <small class="text-muted d-block">Type</small>
                  <strong>{{ vehicle.vehicle_type }}</strong>
                </div>
                {% endif %}
              </div>
              {% else %}
              <div class="alert alert-warning" role="alert">
                <i class="fa fa-exclamation-triangle me-2"></i>No vehicle information
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents">
      {% if documents %}
        {% for doc in documents %}
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1"><i class="fa fa-file me-2"></i>{{ doc.file_name }}</h6>
              <small class="text-muted">
                {{ doc.document_type|upper }} â€¢ Uploaded {{ doc.uploaded_at|date:"M d, H:i" }}
              </small>
            </div>
            <span class="badge bg-{% if doc.extraction_status == 'completed' %}success{% elif doc.extraction_status == 'processing' %}warning{% else %}danger{% endif %}">
              {{ doc.extraction_status|title }}
            </span>
          </div>
          {% if doc.extraction %}
          <div class="card-body">
            <div class="row g-3">
              {% if doc.extraction.extracted_customer_name %}
              <div class="col-md-6">
                <small class="text-muted d-block">Customer Name</small>
                <strong>{{ doc.extraction.extracted_customer_name }}</strong>
              </div>
              {% endif %}
              {% if doc.extraction.extracted_customer_phone %}
              <div class="col-md-6">
                <small class="text-muted d-block">Customer Phone</small>
                <strong>{{ doc.extraction.extracted_customer_phone }}</strong>
              </div>
              {% endif %}
              {% if doc.extraction.extracted_vehicle_plate %}
              <div class="col-md-6">
                <small class="text-muted d-block">Vehicle Plate</small>
                <strong>{{ doc.extraction.extracted_vehicle_plate }}</strong>
              </div>
              {% endif %}
              {% if doc.extraction.extracted_order_description %}
              <div class="col-md-6">
                <small class="text-muted d-block">Service Description</small>
                <strong>{{ doc.extraction.extracted_order_description }}</strong>
              </div>
              {% endif %}
              {% if doc.extraction.extracted_amount %}
              <div class="col-md-6">
                <small class="text-muted d-block">Amount</small>
                <strong>{{ doc.extraction.extracted_amount }}</strong>
              </div>
              {% endif %}
            </div>
            <button type="button" class="btn btn-sm btn-primary mt-3" onclick="applyExtractionToOrder({{ doc.extraction.id }})">
              <i class="fa fa-check me-1"></i> Apply to Order
            </button>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
      <div class="alert alert-info text-center" role="alert">
        <i class="fa fa-info-circle me-2"></i>
        <strong>No documents uploaded yet.</strong>
        <p class="mb-3 mt-2">Upload an invoice to auto-extract customer and service details.</p>
      </div>
      {% endif %}
    </div>

    <!-- Details Tab -->
    <div class="tab-pane fade" id="details">
      <div class="card shadow-sm">
        <div class="card-body">
          {% if order.description %}
          <div class="mb-3">
            <small class="text-muted d-block">Description</small>
            <strong>{{ order.description }}</strong>
          </div>
          {% endif %}
          {% if order.estimated_duration %}
          <div class="mb-3">
            <small class="text-muted d-block">Estimated Duration</small>
            <strong>{{ order.estimated_duration }} minutes</strong>
          </div>
          {% endif %}
          {% if order.item_name %}
          <div class="mb-3">
            <small class="text-muted d-block">Item</small>
            <strong>{{ order.item_name }}</strong>
          </div>
          {% endif %}
          {% if order.brand %}
          <div class="mb-3">
            <small class="text-muted d-block">Brand</small>
            <strong>{{ order.brand }}</strong>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>


<!-- Unified Edit Details Modal -->
<div class="modal fade" id="editDetailsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fa fa-edit me-2"></i><span id="editTitle">Edit Details</span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <!-- Customer Edit Form -->
      <form id="customerEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_customer">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Full Name</label>
            <input type="text" name="full_name" class="form-control" value="{{ customer.full_name }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Phone</label>
            <input type="tel" name="phone" class="form-control" value="{{ customer.phone }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Email</label>
            <input type="email" name="email" class="form-control" value="{{ customer.email|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Address</label>
            <textarea name="address" class="form-control" rows="2">{{ customer.address|default:'' }}</textarea>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Customer Type</label>
            <select name="customer_type" class="form-select">
              <option value="personal" {% if customer.customer_type == 'personal' %}selected{% endif %}>Personal</option>
              <option value="company" {% if customer.customer_type == 'company' %}selected{% endif %}>Company</option>
              <option value="government" {% if customer.customer_type == 'government' %}selected{% endif %}>Government</option>
              <option value="ngo" {% if customer.customer_type == 'ngo' %}selected{% endif %}>NGO</option>
            </select>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>

      <!-- Vehicle Edit Form -->
      {% if vehicle %}
      <form id="vehicleEditForm" method="post" style="display: none;">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_vehicle">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Plate Number</label>
            <input type="text" class="form-control" value="{{ vehicle.plate_number }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Vehicle Type</label>
            <input type="text" name="vehicle_type" class="form-control" value="{{ vehicle.vehicle_type|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Make</label>
            <input type="text" name="make" class="form-control" value="{{ vehicle.make|default:'' }}">
          </div>
          <div class="mb-3">
            <label class="form-label fw-bold">Model</label>
            <input type="text" name="model" class="form-control" value="{{ vehicle.model|default:'' }}">
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<script>
let currentEditMode = 'customer';

function setEditMode(mode) {
  currentEditMode = mode;
  
  // Hide all forms
  document.getElementById('customerEditForm').style.display = 'none';
  if (document.getElementById('vehicleEditForm')) {
    document.getElementById('vehicleEditForm').style.display = 'none';
  }
  
  // Show selected form
  if (mode === 'customer') {
    document.getElementById('editTitle').textContent = 'Edit Customer Information';
    document.getElementById('customerEditForm').style.display = 'block';
  } else if (mode === 'vehicle') {
    document.getElementById('editTitle').textContent = 'Edit Vehicle Information';
    document.getElementById('vehicleEditForm').style.display = 'block';
  }
}

function applyExtractionToOrder(extractionId) {
  if (!confirm('Apply extracted data to this order?')) {
    return;
  }
  
  fetch('{% url "tracker:api_apply_extraction" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({
      order_id: {{ order.id }},
      extraction_id: extractionId,
      apply_fields: ['customer_name', 'customer_phone', 'service_description', 'item_name', 'quantity', 'amount']
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Data applied successfully!');
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error applying extraction data');
  });
}
</script>
{% endblock %}
